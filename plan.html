<!DOCTYPE html><html lang="ja"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ERP • 生産計画</title><link rel="stylesheet" href="style.css"/></head><body>
<div id="headerMount"></div>
<main class="container py-6 space-y-4">
  <section class="card">
    <h3>生産計画</h3>
    <div class="grid md:grid-cols-3 gap-3">
      <label>得意先<input id="pCust" class="input"/></label>
      <label>図番<input id="pDraw" class="input"/></label>
      <label>品名<input id="pName" class="input"/></label>
      <label>品番<input id="pNo" class="input"/></label>
      <label>開始<input id="pStart" type="date" class="input"/></label>
      <label>工程<input id="pProc" class="input"/></label>
    </div>
    <div class="mt-3 flex gap-2">
      <button id="btnPlanAdd" class="btn primary">追加</button>
    </div>
  </section>
  <section class="card">
    <h3>計画一覧</h3>
    <input id="planSearch" class="input" placeholder="検索（得意先/品名/品番）"/>
    <table class="table" id="tblPlan"><thead><tr><th>#</th><th>得意先</th><th>品名</th><th>品番</th><th>開始</th><th>工程</th></tr></thead><tbody></tbody></table>
  </section>
</main>
<script src="app.js"></script>
<script>
fetch('header.html').then(r=>r.text()).then(h=>{document.getElementById('headerMount').outerHTML=h; App.initPage('plan'); init();});
let PLAN_ALL=[];
async function init(){
  document.getElementById('pStart').value = App.todayDate();
  const all = await App.fetchAll(); PLAN_ALL = all.plan||[];
  render(PLAN_ALL);
  document.getElementById('planSearch').addEventListener('input', e=>{
    const v=e.target.value||''; render(App.searchFilter(PLAN_ALL, v, ['customer','itemName','itemNo']));
  });
  document.getElementById('btnPlanAdd').onclick = async ()=>{
    const row = {
      customer: $('#pCust').value, itemName: $('#pName').value, itemNo: $('#pNo').value,
      prodNo: ($('#pDraw').value||''), start: $('#pStart').value, process: $('#pProc').value,
      location:'PPIC/現場など', status:'計画', updated:new Date().toISOString(), user: App.me().user
    };
    await App.appendPlan(row);
    alert('追加しました'); location.reload();
  };
}
function $(q){return document.querySelector(q)}
function render(list){
  const tb=document.querySelector('#tblPlan tbody'); tb.innerHTML='';
  list.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${App.esc(r.customer)}</td><td>${App.esc(r.itemName)}</td>
      <td>${App.esc(r.itemNo)}</td><td>${App.esc((r.start||'').slice(0,10))}</td><td>${App.esc(r.process||'')}</td>`;
    tb.appendChild(tr);
  });
}
</script>
</body></html>
