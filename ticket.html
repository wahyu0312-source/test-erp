<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>生産現品票 | ERPシステム</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800" onload="TicketPage.init()">
  <header class="topbar">
    <div class="brand">
      <img src="tsh.png" alt="TSH" class="h-8"/>
      <span class="ml-2 font-semibold">ERPシステム</span>
    </div>
    <nav class="nav desktop">
      <a href="index.html">ダッシュボード</a>
      <a href="plan.html">生産計画</a>
      <a href="ship.html">出荷計画</a>
      <a href="confirm.html">出荷確認書</a>
      <a href="ticket.html" class="active">生産現品票</a>
      <a href="charts.html">分析チャート</a>
      <a href="master.html">マスター</a>
      <a href="scan.html">QRスキャン</a>
    </nav>
    <div class="flex items-center gap-2">
      <button id="burger" class="burger md:hidden" aria-label="menu">☰</button>
      <button class="btn-outline" onclick="App.logout()">ログアウト</button>
    </div>
  </header>

  <nav id="mobileMenu" class="mobile-menu hidden">
    <a href="index.html">ダッシュボード</a>
    <a href="plan.html">生産計画</a>
    <a href="ship.html">出荷計画</a>
    <a href="confirm.html">出荷確認書</a>
    <a href="ticket.html" class="active">生産現品票</a>
    <a href="charts.html">分析チャート</a>
    <a href="master.html">マスター</a>
    <a href="scan.html">QRスキャン</a>
  </nav>

  <main class="container space-y-6">
    <section class="card">
      <h3 class="card-title">読込／印刷</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <label class="form-row">
          <span>製造番号</span>
          <input id="prodNo" class="input" placeholder="例：1111"/>
        </label>
        <div class="flex items-end gap-2">
          <button class="btn" onclick="TicketPage.load()">読込</button>
          <button class="btn-outline" onclick="window.print()">印刷</button>
        </div>
      </div>
    </section>

    <section class="card printable">
      <div class="flex justify-between items-center">
        <h3 class="card-title">生産現品票</h3>
        <div id="qrcode" class="mr-1"></div>
      </div>

      <div class="ring-1 ring-slate-300">
        <table class="ticket w-full">
          <tbody>
            <tr>
              <th class="w-32">得意先</th>
              <td id="t_customer"></td>
              <th class="w-32">製造番号</th>
              <td id="t_prodNo"></td>
            </tr>
            <tr>
              <th>品名</th><td id="t_itemName"></td>
              <th>品番</th><td id="t_itemNo"></td>
            </tr>
            <tr>
              <th>開始</th><td id="t_start"></td>
              <th>担当</th><td id="t_user"></td>
            </tr>
          </tbody>
        </table>

        <table class="ticket w-full">
          <tbody>
            <tr>
              <th class="w-32">工程名</th>
              <td id="t_process"></td>
              <th class="w-32">重要ポイント</th>
              <td id="t_points"></td>
            </tr>
            <tr>
              <th>作業者</th><td></td>
              <th>着手</th><td></td>
            </tr>
            <tr>
              <th>完了</th><td></td>
              <th>判定</th><td></td>
            </tr>
            <tr>
              <th>不合格理由/処置/修正内容</th>
              <td colspan="3" style="height:80px"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="app.js"></script>
  <script>
    const TicketPage = {
      data:null, qr:null,
      init(){ App.ensureAuth(); App.mountBurger(); },
      async load(){
        const prodNo = document.getElementById('prodNo').value.trim();
        if(!prodNo){ alert('製造番号を入力'); return; }
        const {plan} = await App.fetchAll();             // PLAN sheet
        const r = (plan||[]).find(x=>String(x.prodNo||'')===prodNo);
        if(!r){ alert('見つかりません。'); return; }
        // fill
        this.data=r;
        document.getElementById('t_customer').textContent=r.customer||'';
        document.getElementById('t_prodNo').textContent=r.prodNo||'';
        document.getElementById('t_itemName').textContent=r.itemName||'';
        document.getElementById('t_itemNo').textContent=r.itemNo||'';
        document.getElementById('t_start').textContent=r.start||'';
        document.getElementById('t_user').textContent=App.me()?.user||'';
        document.getElementById('t_process').textContent=r.process||'';
        document.getElementById('t_points').textContent='';

        // QR: encode JSON ringkas
        const payload = {type:'ticket', prodNo:r.prodNo, item:r.itemNo};
        const elm = document.getElementById('qrcode');
        elm.innerHTML='';
        this.qr=new QRCode(elm, {text: JSON.stringify(payload), width:96, height:96});
      }
    }
  </script>

  <style>
    /* cetak */
    @media print{
      header, .btn, .btn-outline, .burger, #mobileMenu { display:none !important; }
      .card { box-shadow:none; border:0; padding:0 }
      .printable{ page-break-inside:avoid }
    }
    .ticket th{ @apply bg-slate-100 text-slate-700 p-2 border border-slate-300 text-sm; }
    .ticket td{ @apply p-2 border border-slate-300 text-sm; }
  </style>
</body>
</html>
